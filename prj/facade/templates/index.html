{% set active_page = "index" %}
<!DOCTYPE HTML>
<html lang="en">
<head>
{% include '_head_import.html' %}
<link rel="stylesheet" href="http://js.arcgis.com/3.13/dijit/themes/claro/claro.css">
<link rel="stylesheet" href="http://js.arcgis.com/3.13/esri/css/esri.css">
<link href="{{ url_for('facade.static', filename='3rd/leaflet/leaflet.css') }}" rel="stylesheet"/>
<link href="{{ url_for('facade.static', filename='3rd/leaflet-overview/leaflet-overview.css') }}" rel="stylesheet"/>
<link href="{{ url_for('facade.static', filename='css/main.css')}}" rel="stylesheet" media="screen">    
<script src="{{ url_for('facade.static', filename='3rd/leaflet/leaflet.js')}}" type="text/javascript"></script>
<script src="{{ url_for('facade.static', filename='3rd/leaflet-overview/leaflet-overview.js')}}" type="text/javascript"></script>
<script type="text/javascript" src="{{ url_for('facade.static', filename='js/slidepanel-right.js')}}"></script>
<script src="http://js.arcgis.com/3.13/"></script>

    
</head>
<body>    
<div class="container-fluid ">
    
    {% include '_top_nav_import.html' %}

<!--
<a href="#1" onClick="getPanelData('kpg')">test</a>
-->

    <div id="main-outer">

	    <!-- main-content  -->
        <div id="main-content">
            <nav id="main-nav">
                <ul id="navigation">
                    <li>
                        <a href="#panel" id="panel-button">&laquo;&nbsp;open</a>
                    </li>    
                </ul>
            </nav>

        <!-- map -->
	    <div id="map"></div>

        </div>
	    <!-- // main-content  -->


        <!-- right panel  -->
        {% include '_right_panel.html' %}
         <!-- // right panel  -->

    </div>    
          
    <!--
    <div class="row">
      <div class="col-md-6">Description</div>
      <div class="col-md-6">Available Resources</div>
    </div>
    -->
</div>  


    
<script>



$(function() {

    // Resize map height
    // -------
    var top_height = $('#main-top').height() + 70;

    $('#map').height($(window).height() - top_height);
    $("#panel").height($(window).height() - top_height);

    $(window).resize(function() {
        var bodyheight = $(window).height() - top_height;
        $("#map").height(bodyheight);
        $("#panel").height(bodyheight);
    }); 

    // MAP INITIALIZATION
    // --------
    var map;
    var fLayers;
    var fLayer;
    require(["esri/map",
        "esri/arcgis/utils",
        "esri/layers/FeatureLayer",
        "esri/graphic",
        "esri/tasks/query",
        "esri/geometry/Point", 
        "dojo/domReady!"], 
        function(Map, arcgisUtils, FeatureLayer, Graphic, Query, Point) {
            // WebMap option to disable popups window
            var createMapOptions = { ignorePopups: true };
            // Create a map with a webmap from arcgis.com
            arcgisUtils.createMap("4263c3792e774f6e896ba959a8832cf0", "map", createMapOptions).then(initializeMap);
            
            // Initialize Map and register related events.
            function initializeMap(response) {
                // Get a created map.
                map = response.map;
                // Create a feature layer to query
                var serviceURL = "https://services1.arcgis.com/DnZ5orhsUGGdUZ3h/arcgis/rest/services/ProtoypeService_04222015/FeatureServer/0"
                fLayer = new FeatureLayer(serviceURL, { outFields: ["LangName", "ISO_639"] } );    
                // Register query event.
                map.on('click', function(evt) {
                    // Create a query
                    var geometry = evt.mapPoint;
                    var query = new Query();
                    query.geometry = geometry;
                    // Query a selected feature
                    fLayer.queryFeatures(query, displayFeatureInfo);
                });                        
            }
        
            // Register a click event
            function displayFeatureInfo(response) {
                var feature = response.features[0];
                // Get iso 639 code to be used in subsequent queries.
                var iso639 = feature.attributes['ISO_639'];
                // For debugging
                //alert("selected feature iso 639 code: " + iso639);                
                $('#div_iso_639').html( iso639 );
		        getPanelData( iso639 );

            }		
        }
    );  // End require

}); // End outer function




// right panel data search
function getPanelData(iso_code){
    $('#div_sildata').html( "<p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p>" );
    $('#div_jfmdata').html( "<p>&nbsp;</p><p>&nbsp;</p><p>&nbsp;</p>" );
    getSilDataOne( iso_code );
    var languageIds = 12200; // temp
    getJfmDescData( languageIds );
}   


// sil data search callback
function getSilDataOneCallback(response){
    var re_html = "";
    if( response.iso_code ){
        re_html += "Reference name: "+ response.reference_name + "</br>";
        re_html += "Bible translation status: "+ response.existing_scripture + "</br>";
        re_html += "Existing scripture: "+ response.existing_scripture_dis + "</br>";
        $('#div_sildata').html( re_html );
        openSidePanel();
    }else{
        //alert("no data!");
    }
}

// jfm desc data
function getJfmDescDataCallback(response){
    var re_html = "";
    // shortDescription      longDescription
    var obj_1 = response.data[0];
    var obj_2 = response.data[1];
    if( obj_1  && obj_1._embedded.mediaComponents[0] ){
        openSidePanel();
        re_html = obj_1._embedded.mediaComponents[0].longDescription;
        re_html = re_html.replace(/(?:\r\n|\r|\n)/g, '<br />');
        re_html += "</br></br>";
        re_html += "<img src='"+obj_1._embedded.mediaComponents[0].imageUrls.videoStill+"' width='100%'>";
        if( obj_2.downloadUrls.high.url ){
            var webPlayer_str = obj_2.webEmbedPlayer;
            if( webPlayer_str ){
                webPlayer_str = webPlayer_str.replace("640", "100%");
                webPlayer_str = webPlayer_str.replace("360", "240");
                re_html += "<br>"+webPlayer_str;
            }
            re_html += "<br><a href='"+obj_2.downloadUrls.high.url+"' >mp4 video file download</a>";
        }
        re_html += "<p>&nbsp;</p><p>&nbsp;</p>";
        $('#div_jfmdata').html( re_html );
    }    
}



</script>
    
</body>
</html>